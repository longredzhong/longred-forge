name: Auto Update Recipes

on:
  schedule:
    # Run every hour at minute 10, every 3 hours
    - cron: "10 */3 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write # Required to trigger workflows
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ⚙️ Install pixi env
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: v0.62.2
          activate-environment: true

      - name: Run updater for all recipes (apply) via pixi
        run: |
          # Run updater without --recipe so it processes all recipes under recipes/*/recipe.yaml
          pixi run python scripts/update.py --apply

      - name: Commit & push recipe changes
        id: commit
        env:
          # Use PAT to trigger downstream workflows. If not available, falls back to GITHUB_TOKEN (won't trigger workflows)
          GIT_TOKEN: ${{ secrets.PERSONAL_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          # show changes for debugging
          git status --porcelain
          # stage any modified recipe files
          git add recipes/*/recipe.yaml || true
          if git diff --cached --quiet; then
            echo "No recipe changes to commit"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore: auto-update recipes"
            # Push using PAT to trigger Build & Publish workflow
            git push "https://x-access-token:${GIT_TOKEN}@github.com/${{ github.repository }}" HEAD:main
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Build & Publish workflow
        if: steps.commit.outputs.changed == 'true'
        env:
          HAS_PAT: ${{ secrets.PERSONAL_TOKEN != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            // Only manually trigger if not using PAT (PAT push will auto-trigger)
            if (process.env.HAS_PAT === 'true') {
              console.log('Using PAT - workflow will be auto-triggered by push');
              return;
            }

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'main.yaml',
              ref: 'main'
            });
            console.log('Manually triggered Build & Publish workflow');
