name: Auto Update Recipes

on:
  schedule:
    # Run every hour at minute 10, every 3 hours
    - cron: "10 */3 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write # Required to trigger workflows (workflow_dispatch)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ⚙️ Install pixi env
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: v0.62.2
          activate-environment: true

      - name: Run updater for all recipes (apply) via pixi
        run: |
          # Run updater without --recipe so it processes all recipes under recipes/*/recipe.yaml
          pixi run python scripts/update.py --apply

      - name: Commit & push recipe changes
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          # show changes for debugging
          git status --porcelain
          # stage any modified recipe files
          git add recipes/*/recipe.yaml || true
          if git diff --cached --quiet; then
            echo "No recipe changes to commit"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore: auto-update recipes"
            # Push the commit back to main.
            # Note: pushes made with GITHUB_TOKEN do NOT trigger other workflows via `on: push`,
            # so we will trigger Build & Publish via workflow_dispatch in the next step.
            git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}" HEAD:main
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Build & Publish workflow
        if: steps.commit.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'main.yaml',
              ref: 'main'
            });
            console.log('Manually triggered Build & Publish workflow');
