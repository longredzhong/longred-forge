name: Auto Update Recipes

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ⚙️ Install pixi env
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: v0.62.2
          activate-environment: true

      - name: Run updater for all recipes (apply) via pixi
        run: |
          # Run updater without --recipe so it processes all recipes under recipes/*/recipe.yaml
          pixi run python scripts/update.py --apply

      - name: Commit & push recipe changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          # show changes for debugging
          git status --porcelain
          # stage any modified recipe files
          git add recipes/*/recipe.yaml || true
          if git diff --cached --quiet; then
            echo "No recipe changes to commit"
          else
            git commit -m "chore: auto-update recipes"
            # Push to main. If branch protection prevents a push with GITHUB_TOKEN,
            # provide a Personal Access Token in secrets.PERSONAL_TOKEN.
            if [ -n "${{ secrets.PERSONAL_TOKEN }}" ]; then
              git push "https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/${{ github.repository }}" HEAD:main
            else
              git push origin HEAD:main
            fi
          fi
